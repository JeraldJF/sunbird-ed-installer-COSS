{{- if .Values.lets_encrypt_ssl }}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: certbot
  namespace: {{ .Release.Namespace }}
  labels:
    app: certbot
spec:
  schedule: "0 18 */85 * *" # Every 85th day at 6:00 PM UTC (~12:30 AM IST)
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: certbot
        spec:
          serviceAccountName: certbot
          restartPolicy: Never
          containers:
            - name: certbot
              image: alpine:3.20
              command: ["/bin/sh"]
              args:
                - -c
                - |
                  set -e
                  echo ">>> Installing dependencies..."
                  apk add --no-cache certbot bash curl jq kubectl msmtp ca-certificates

                  echo ">>> Creating msmtp config..."
                  cat <<EOF > /etc/msmtprc
                  defaults
                  tls on
                  tls_trust_file /etc/ssl/certs/ca-certificates.crt
                  logfile /var/log/msmtp.log

                  account default
                  host {{ .Values.smtp.host }}
                  port {{ .Values.smtp.port }}
                  auth on
                  user {{ .Values.smtp.user }}
                  password {{ .Values.smtp.pass }}
                  from {{ .Values.smtp.from }}
                  EOF
                  chmod 600 /etc/msmtprc

                  echo ">>> Copying renewal script to /tmp..."
                  cp /opt/renew.sh /tmp/renew.sh
                  chmod +x /tmp/renew.sh

                  echo ">>> Running renewal script..."
                  /tmp/renew.sh

              env:
                - name: EMAIL
                  value: {{ .Values.smtp.to }}
                - name: DOMAIN
                  value: {{ .Values.global.domain }}
                - name: CERTBOT_STAGING
                  value: "true"
              volumeMounts:
                - name: renewscript
                  mountPath: /opt/renew.sh
                  subPath: renew.sh
          volumes:
            - name: renewscript
              configMap:
                name: certbot

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: certbot
  namespace: {{ .Release.Namespace }}
data:
  renew.sh: |-
    #!/bin/sh
    set -e

    echo "=============================================="
    echo "Starting certificate renewal for: ${DOMAIN}"
    echo "=============================================="

    CERT_DIR="/etc/letsencrypt/live/${DOMAIN}"

    if [ "$CERTBOT_STAGING" = "true" ]; then
      echo "Environment: STAGING (Test Certificates)"
      SERVER="--server https://acme-staging-v02.api.letsencrypt.org/directory"
    else
      echo "Environment: PRODUCTION (Real Certificates)"
      SERVER="--server https://acme-v02.api.letsencrypt.org/directory"
    fi

    echo ">>> Updating nginx-public-ingress selector to certbot..."
    kubectl patch svc nginx-public-ingress -n {{ .Release.Namespace }} \
      --type='json' \
      -p='[{"op": "replace", "path": "/spec/selector", "value": {"app":"certbot"}}]'

    echo ">>> Running Certbot standalone issuance..."
    if certbot certonly --non-interactive --agree-tos --email "$EMAIL" --standalone -d "$DOMAIN" $SERVER; then
      echo "✅ Certbot succeeded"
      STATUS="SUCCESS"
    else
      echo "❌ Certbot failed"
      STATUS="FAILED"
    fi

    if [ -f "$CERT_DIR/fullchain.pem" ] && [ -f "$CERT_DIR/privkey.pem" ]; then
      echo "✅ Certificate files exist"

      kubectl get configmap nginx-public-ingress -n {{ .Release.Namespace }} -o yaml > /tmp/cm.yaml

      echo "  tls.crt: |-" > /tmp/new_tls.yaml
      sed 's/^/    /' "$CERT_DIR/fullchain.pem" >> /tmp/new_tls.yaml
      echo "  tls.key: |-" >> /tmp/new_tls.yaml
      sed 's/^/    /' "$CERT_DIR/privkey.pem" >> /tmp/new_tls.yaml

      awk '
        BEGIN {skip=0}
        /^  tls.crt:/ {system("cat /tmp/new_tls.yaml"); skip=1; next}
        /^  tls.key:/ {skip=1; next}
        skip && /^[^ ]/ {skip=0}
        !skip {print}
      ' /tmp/cm.yaml > /tmp/updated-cm.yaml

      if kubectl apply -f /tmp/updated-cm.yaml -n {{ .Release.Namespace }}; then
        echo "✅ ConfigMap updated"
      else
        echo "❌ Failed to update ConfigMap"
      fi

      if kubectl rollout restart deployment nginx-public-ingress -n {{ .Release.Namespace }}; then
        echo "✅ Nginx deployment restarted"
      else
        echo "❌ Failed to restart Nginx deployment"
      fi
    else
      echo "❌ Certificate files not found"
    fi

    echo ">>> Restoring nginx-public-ingress selector to nginx..."
    kubectl patch svc nginx-public-ingress -n {{ .Release.Namespace }} \
      --type='json' \
      -p='[{"op": "replace", "path": "/spec/selector", "value": {"app.kubernetes.io/name":"nginx-public-ingress"}}]'

    echo ">>> Sending notification mail..."
    MAIL_SUBJECT="Certbot renewal for ${DOMAIN} - $STATUS"
    MAIL_BODY="Hello,\n\nThe Certbot SSL renewal job for ${DOMAIN} finished with status: $STATUS.\n\nRegards,\nYour Kubernetes CronJob"

    if printf "To: %s\nSubject: %s\n\n%s\n" "$EMAIL" "$MAIL_SUBJECT" "$MAIL_BODY" | msmtp "$EMAIL"; then
      echo "✅ Notification sent to $EMAIL"
    else
      echo "⚠️ Failed to send notification"
    fi

    echo "✅ Renewal process completed!"

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: certbot
  namespace: {{ .Release.Namespace }}

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: certbot
  namespace: {{ .Release.Namespace }}
rules:
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "list", "watch", "patch", "update"]
  - apiGroups: [""]
    resources: ["configmaps", "services"]
    verbs: ["get", "list", "watch", "patch", "update"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: certbot
  namespace: {{ .Release.Namespace }}
subjects:
  - kind: ServiceAccount
    name: certbot
roleRef:
  kind: Role
  name: certbot
  apiGroup: rbac.authorization.k8s.io
{{- end }}
